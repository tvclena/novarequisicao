<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta de Produto - Debug Total</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Inter, Arial, sans-serif;
  background: #f5f6f8;
  margin: 0;
  padding: 30px;
}
h1 {
  margin-bottom: 20px;
}
input {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin-bottom: 10px;
}
button {
  padding: 14px 24px;
  font-size: 16px;
  background: #ff6a00;
  border: none;
  color: #fff;
  border-radius: 8px;
  cursor: pointer;
}
button:hover {
  opacity: 0.9;
}
.card {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}
.debug {
  background: #0f172a;
  color: #e5e7eb;
  padding: 16px;
  border-radius: 10px;
  margin-top: 20px;
  font-family: monospace;
  font-size: 13px;
  white-space: pre-wrap;
}
.error {
  background: #fee2e2;
  color: #7f1d1d;
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
}
.ok {
  background: #dcfce7;
  color: #14532d;
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
}
</style>
</head>

<body>

<h1>üì¶ Consulta de Produto (Debug Total)</h1>

<input id="produtoId" placeholder="Digite o ID do produto (ex: 1178)">
<button onclick="buscarProduto()">Buscar</button>

<div id="status"></div>
<div id="produto"></div>
<div id="debug" class="debug"></div>

<script>
function log(msg) {
  const dbg = document.getElementById('debug');
  dbg.textContent += msg + "\n";
  dbg.scrollTop = dbg.scrollHeight;
}

async function buscarProduto() {
  document.getElementById('produto').innerHTML = '';
  document.getElementById('status').innerHTML = '';
  document.getElementById('debug').textContent = '';

  const id = document.getElementById('produtoId').value.trim();
  if (!id) return;

  try {
    // ===============================
    // 1Ô∏è‚É£ GERAR TOKEN
    // ===============================
    log("üîê CHAMANDO /api/auth");

    const authUrl = `${location.origin}/api/auth`;
    log("URL AUTH: " + authUrl);

    const authRes = await fetch(authUrl);
    log("STATUS AUTH: " + authRes.status);

    const authText = await authRes.text();
    log("RESPOSTA AUTH (RAW):\n" + authText);

    let authJson;
    try {
      authJson = JSON.parse(authText);
    } catch {
      throw new Error("Resposta do /api/auth N√ÉO √© JSON");
    }

    if (!authJson.accessToken) {
      throw new Error("Token n√£o retornado");
    }

    const token = authJson.accessToken;
    log("‚úÖ TOKEN GERADO:\n" + token);

    document.getElementById('status').innerHTML =
      `<div class="ok">Token gerado com sucesso</div>`;

    // ===============================
    // 2Ô∏è‚É£ BUSCAR PRODUTO
    // ===============================
    const produtoUrl =
      `${location.origin}/api/produto?id=${id}`;

    log("\nüì¶ CHAMANDO PRODUTO");
    log("URL PRODUTO: " + produtoUrl);

    const prodRes = await fetch(produtoUrl);
    log("STATUS PRODUTO: " + prodRes.status);

    const prodText = await prodRes.text();
    log("RESPOSTA PRODUTO (RAW):\n" + prodText);

    let prodJson;
    try {
      prodJson = JSON.parse(prodText);
    } catch {
      throw new Error("Resposta do /api/produto N√ÉO √© JSON");
    }

    if (!prodJson.items || !prodJson.items.length) {
      document.getElementById('status').innerHTML =
        `<div class="error">Produto n√£o encontrado</div>`;
      return;
    }

    const p = prodJson.items[0];

    // ===============================
    // 3Ô∏è‚É£ RENDERIZA CARD
    // ===============================
    document.getElementById('produto').innerHTML = `
      <div class="card">
        <h2>${p.descricao}</h2>
        <p><b>ID:</b> ${p.id}</p>
        <p><b>Descri√ß√£o reduzida:</b> ${p.descricaoReduzida}</p>
        <p><b>Unidade:</b> ${p.unidadeDeVenda}</p>
        <p><b>Grupo:</b> ${p.grupoId}</p>
        <p><b>Se√ß√£o:</b> ${p.secaoId}</p>
        <p><b>Controla estoque:</b> ${p.controlaEstoque}</p>
        <p><b>Ativo no ecommerce:</b> ${p.ativoNoEcommerce}</p>
        <p><b>Data inclus√£o:</b> ${p.dataInclusao}</p>
      </div>
    `;

  } catch (err) {
    document.getElementById('status').innerHTML =
      `<div class="error">ERRO: ${err.message}</div>`;
    log("\n‚ùå ERRO FINAL:");
    log(err.stack || err.message);
  }
}
</script>

</body>
</html>
