<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Produto - Debug Total</title>
<style>
body { font-family: Arial; background:#f4f6f8; padding:40px }
input { padding:12px; width:300px }
button { padding:12px 20px; background:#ff6a00; color:#fff; border:none; cursor:pointer }
pre { background:#0f172a; color:#e5e7eb; padding:15px; border-radius:8px; overflow:auto }
.card { background:#fff; padding:20px; border-radius:12px; margin-top:20px }
.error { background:#fee2e2; color:#991b1b; padding:12px; border-radius:8px }
</style>
</head>
<body>

<h1>üì¶ Consulta de Produto (Debug Total)</h1>

<input id="idProduto" placeholder="Digite o ID do produto">
<button onclick="buscarProduto()">Buscar</button>

<div id="msg"></div>
<pre id="debug"></pre>
<div id="produto"></div>

<script>
async function buscarProduto() {
  const id = document.getElementById('idProduto').value.trim();
  const debug = document.getElementById('debug');
  const produtoDiv = document.getElementById('produto');
  const msg = document.getElementById('msg');

  debug.textContent = "";
  produtoDiv.innerHTML = "";
  msg.innerHTML = "";

  try {
    debug.textContent += "üîê GERANDO TOKEN...\n";

    const authResp = await fetch("/api/auth");
    const authText = await authResp.text();
    debug.textContent += "AUTH RAW:\n" + authText + "\n\n";

    const auth = JSON.parse(authText);
    const token = auth.accessToken;

    if (!token) throw new Error("Token n√£o retornado");

    debug.textContent += "TOKEN OK\n\n";

    const urlProduto = `/api/produto?id=${id}`;
    debug.textContent += "üì¶ CHAMANDO PRODUTO:\n" + urlProduto + "\n";
    debug.textContent += "AUTH HEADER:\n" + token + "\n\n";

    const prodResp = await fetch(urlProduto, {
      headers: {
        Authorization: `${token}`
      }
    });

    const prodText = await prodResp.text();
    debug.textContent += "PRODUTO RAW:\n" + prodText + "\n";

    const json = JSON.parse(prodText);

    if (!json.items || !json.items.length) {
      msg.innerHTML = `<div class="error">Produto n√£o encontrado</div>`;
      return;
    }

    const p = json.items[0];

    produtoDiv.innerHTML = `
      <div class="card">
        <h2>${p.descricao}</h2>
        <p><b>ID:</b> ${p.id}</p>
        <p><b>Unidade:</b> ${p.unidadeDeVenda}</p>
        <p><b>Estoque:</b> ${p.controlaEstoque ? "Sim" : "N√£o"}</p>
        <p><b>Pre√ßo vari√°vel:</b> ${p.precoVariavel ? "Sim" : "N√£o"}</p>
        <p><b>√öltima altera√ß√£o:</b> ${p.dataAlteracao}</p>
      </div>
    `;

  } catch (err) {
    msg.innerHTML = `<div class="error">ERRO: ${err.message}</div>`;
    debug.textContent += "\nERRO:\n" + err.message;
  }
}
</script>

</body>
</html>
