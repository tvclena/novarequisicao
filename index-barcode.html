<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitura por C√≥digo de Barras</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:Inter;background:#f4f6f8;padding:40px}
input{padding:14px;width:360px;font-size:18px}
button{padding:14px 22px;background:#ff6a00;color:#fff;border:none;border-radius:8px;cursor:pointer}
pre{background:#020617;color:#e5e7eb;padding:16px;border-radius:12px;margin-top:20px;max-height:300px;overflow:auto}
.card{background:#fff;padding:24px;border-radius:18px;margin-top:20px}
.error{background:#fee2e2;color:#991b1b;padding:14px;border-radius:10px}
</style>
</head>

<body>

<h1>üì¶ Leitura por C√≥digo de Barras</h1>

<input id="barcode" placeholder="Passe o leitor ou digite" autofocus>
<button onclick="buscar()">Buscar</button>

<pre id="debug"></pre>
<div id="resultado"></div>

<script>
let produto = null;

async function buscar(){
  const barcode = barcodeInput.value.trim();
  debug.textContent = "üîç BUSCANDO...\n";
  resultado.innerHTML = "";

  const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`);
  const raw = await resp.text();
  debug.textContent += raw + "\n";

  const json = JSON.parse(raw);

  if(json.error){
    resultado.innerHTML = `<div class="error">${json.error}</div>`;
    return;
  }

  produto = json.produto;

  resultado.innerHTML = `
    <div class="card">
      <h2>${produto.descricao}</h2>
      <p><b>ID:</b> ${produto.id}</p>
      <p><b>Unidade:</b> ${produto.unidadeDeVenda}</p>

      <input id="qtd" type="number" value="1" min="1">
      <br><br>
      <button onclick="enviar()">üì§ Enviar Requisi√ß√£o</button>
    </div>
  `;
}

async function enviar(){
  const body = {
    dataTransferencia: new Date().toISOString().substring(0,10),
    dataRecebimento: new Date().toISOString().substring(0,10),
    tipo: "TRANSFERENCIA",
    status: "ABERTA",
    modelo: "DIRETA",
    lojaId: 1,
    localOrigemId: 1,
    localDestinoId: 1,
    setorId: 1,
    solicitanteId: 112,
    motivoRequisicaoId: 1,
    observacaoGeral: "Via scanner",
    total: Number(qtd.value),
    itens: [{
      produtoId: produto.id,
      quantidadeTransferida: Number(qtd.value),
      observacao: "",
      custoMedio: 0,
      custo: 0,
      custoReposicao: 0,
      custoFiscal: 0
    }]
  };

  debug.textContent += "\nüì§ ENVIANDO...\n" + JSON.stringify(body, null, 2);

  const resp = await fetch("/api/requisicao", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const raw = await resp.text();
  debug.textContent += "\nRESPONSE:\n" + raw;
}
</script>

</body>
</html>
