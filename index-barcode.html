<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de C√≥digo de Barras</title>

<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  font-family:Inter,Arial;
  background:#f4f6f8;
}
h1{font-size:22px;margin-bottom:12px}

button{
  width:100%;
  padding:18px;
  font-size:18px;
  font-weight:700;
  border:none;
  border-radius:18px;
  background:#ff6a00;
  color:#fff;
}

input{
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:16px;
  border:1px solid #cbd5e1;
  margin-top:12px;
}

video{
  width:100%;
  border-radius:20px;
  margin-top:20px;
  background:#000;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:20px;
  margin-top:20px;
}

.hidden{display:none}
.small{font-size:14px;color:#64748b;margin-top:6px}
</style>
</head>

<body>

<h1>üì¶ Leitura de C√≥digo de Barras</h1>

<button id="btnCamera">üì∑ Abrir c√¢mera</button>

<input id="manual"
  placeholder="Ou digite o c√≥digo de barras manualmente">

<div class="small">
  A leitura continuar√° at√© encontrar um produto v√°lido.
</div>

<video id="video"
  playsinline
  autoplay
  muted
></video>

<div id="resultado"></div>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAAA">
</audio>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
let stream = null;
let lendo = false;
let buscando = false;

const video = document.getElementById("video");
const resultado = document.getElementById("resultado");
const beep = document.getElementById("beep");

// ====== BOT√ÉO C√ÇMERA (OBRIGAT√ìRIO NO IPHONE)
document.getElementById("btnCamera").onclick = async () => {
  if(stream) return;

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });

    video.srcObject = stream;
    await video.play();

    iniciarLeitura();
  }catch(err){
    alert("Permiss√£o de c√¢mera negada");
  }
};

// ====== INPUT MANUAL
document.getElementById("manual").addEventListener("keydown", e=>{
  if(e.key === "Enter"){
    const code = e.target.value.trim();
    if(code) buscarProduto(code);
  }
});

// ====== INICIA QUAGGA (LEITURA CONT√çNUA)
function iniciarLeitura(){
  if(lendo) return;
  lendo = true;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:video,
      constraints:{}
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_8_reader",
        "code_128_reader",
        "upc_reader",
        "upc_e_reader"
      ]
    },
    locate:true
  }, err=>{
    if(err){
      alert("Erro ao iniciar leitor");
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(res=>{
    if(!res.codeResult?.code) return;
    if(buscando) return;

    const code = res.codeResult.code;
    buscarProduto(code);
  });
}

// ====== BUSCA PRODUTO (S√ì PARA QUANDO ACHAR)
async function buscarProduto(barcode){
  buscando = true;

  resultado.innerHTML = `
    <div class="card">
      üîç Buscando produto para c√≥digo <b>${barcode}</b>...
    </div>
  `;

  try{
    const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`);
    const json = await resp.json();

    // ‚ùå N√ÉO ACHOU ‚Üí CONTINUA LENDO
    if(json.error){
      buscando = false;
      return;
    }

    // ‚úÖ ACHOU ‚Üí PARA TUDO
    beep.play();
    pararCamera();

    const p = json.produto;

    resultado.innerHTML = `
      <div class="card">
        <h2>${p.descricao}</h2>
        <p><b>ID:</b> ${p.id}</p>
        <p><b>Unidade:</b> ${p.unidadeDeVenda}</p>
        <p><b>Controla estoque:</b> ${p.controlaEstoque ? "Sim" : "N√£o"}</p>

        <label>Quantidade</label>
        <input type="number" min="1" value="1">
      </div>
    `;

  }catch(err){
    buscando = false;
  }
}

// ====== PARA C√ÇMERA
function pararCamera(){
  lendo = false;
  buscando = false;

  Quagga.stop();

  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
}
</script>

</body>
</html>
