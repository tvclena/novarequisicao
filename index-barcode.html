<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de C√≥digo de Barras ‚Äì Debug Total</title>

<meta name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  font-family:Inter,Arial;
  background:#f4f6f8;
}
h1{font-size:22px;margin-bottom:10px}

button{
  width:100%;
  padding:16px;
  font-size:18px;
  font-weight:700;
  border:none;
  border-radius:16px;
  background:#ff6a00;
  color:#fff;
  margin-top:10px;
}

button.secondary{
  background:#0f172a;
}

input{
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  margin-top:10px;
}

video{
  width:100%;
  margin-top:14px;
  border-radius:18px;
  background:#000;
}

.card{
  background:#fff;
  padding:18px;
  border-radius:18px;
  margin-top:14px;
}

pre{
  background:#020617;
  color:#e5e7eb;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  max-height:280px;
  overflow:auto;
  font-size:13px;
}

.small{
  font-size:13px;
  color:#64748b;
  margin-top:6px;
}

.hidden{display:none}
</style>
</head>

<body>

<h1>üì¶ Leitura de C√≥digo de Barras</h1>

<button id="btnCamera">üì∑ Abrir c√¢mera</button>

<input id="manual" placeholder="Digite o c√≥digo de barras manualmente">

<button class="secondary" id="btnManual">üîç Buscar manualmente</button>

<div class="small">
  A leitura por c√¢mera continuar√° at√© encontrar um produto v√°lido.
</div>

<video id="video"
  playsinline
  autoplay
  muted
></video>

<div id="resultado"></div>

<pre id="debug"></pre>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAAA">
</audio>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
let stream = null;
let lendo = false;
let buscando = false;
let token = null;

const video = document.getElementById("video");
const resultado = document.getElementById("resultado");
const debug = document.getElementById("debug");
const beep = document.getElementById("beep");

// ======================= DEBUG HELPER
function log(msg){
  debug.textContent += msg + "\n";
  debug.scrollTop = debug.scrollHeight;
}

// ======================= AUTH
async function obterToken(){
  log("üîê GERANDO TOKEN...");

  const resp = await fetch("/api/auth");
  const raw = await resp.text();

  log("AUTH STATUS: " + resp.status);
  log("AUTH RAW:");
  log(raw);

  if(!resp.ok){
    throw new Error("Erro ao gerar token");
  }

  const json = JSON.parse(raw);
  token = json.accessToken;

  log("‚úÖ TOKEN GERADO:");
  log(token);
}

// ======================= BOT√ÉO C√ÇMERA (OBRIGAT√ìRIO NO IPHONE)
document.getElementById("btnCamera").onclick = async () => {
  if(stream) return;

  try{
    if(!token){
      await obterToken();
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });

    video.srcObject = stream;
    await video.play();

    iniciarLeitura();
  }catch(err){
    log("‚ùå ERRO C√ÇMERA: " + err.message);
    alert("Erro ao abrir c√¢mera");
  }
};

// ======================= BOT√ÉO MANUAL
document.getElementById("btnManual").onclick = async () => {
  const code = document.getElementById("manual").value.trim();
  if(!code) return;

  if(!token){
    await obterToken();
  }

  buscarProduto(code);
};

// ======================= QUAGGA ‚Äì LEITURA CONT√çNUA
function iniciarLeitura(){
  if(lendo) return;
  lendo = true;

  log("üì∑ INICIANDO LEITURA CONT√çNUA...");

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:video,
      constraints:{}
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_8_reader",
        "code_128_reader",
        "upc_reader",
        "upc_e_reader"
      ]
    },
    locate:true
  }, err=>{
    if(err){
      log("‚ùå ERRO QUAGGA: " + err.message);
      return;
    }
    Quagga.start();
    log("‚úÖ QUAGGA ATIVO");
  });

  Quagga.onDetected(res=>{
    if(!res.codeResult?.code) return;
    if(buscando) return;

    const code = res.codeResult.code;
    log("üì° C√ìDIGO DETECTADO: " + code);

    buscarProduto(code);
  });
}

// ======================= BUSCAR PRODUTO
async function buscarProduto(barcode){
  buscando = true;

  resultado.innerHTML = `
    <div class="card">
      üîç Buscando produto para c√≥digo <b>${barcode}</b>...
    </div>
  `;

  log("‚û°Ô∏è BUSCANDO PRODUTO: " + barcode);

  try{
    const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`,{
      headers:{
        "Authorization": token
      }
    });

    const raw = await resp.text();

    log("PRODUTO STATUS: " + resp.status);
    log("PRODUTO RAW:");
    log(raw);

    const json = JSON.parse(raw);

    if(json.error){
      buscando = false;
      return; // continua lendo, sem erro visual
    }

    // ACHOU PRODUTO
    beep.play();
    pararCamera();

    const p = json.produto;

    resultado.innerHTML = `
      <div class="card">
        <h2>${p.descricao}</h2>
        <p><b>ID:</b> ${p.id}</p>
        <p><b>Unidade:</b> ${p.unidadeDeVenda}</p>
        <p><b>Controla estoque:</b> ${p.controlaEstoque ? "Sim" : "N√£o"}</p>
        <p><b>√öltima altera√ß√£o:</b> ${p.dataAlteracao}</p>

        <label>Quantidade</label>
        <input type="number" min="1" value="1">
      </div>
    `;

  }catch(err){
    log("‚ùå ERRO BUSCA: " + err.message);
    buscando = false;
  }
}

// ======================= PARAR C√ÇMERA
function pararCamera(){
  lendo = false;
  buscando = false;

  Quagga.stop();

  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }

  log("üõë C√ÇMERA PARADA");
}
</script>

</body>
</html>
