<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de C칩digo de Barras</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  font-family:Inter,Arial;
  background:#f4f6f8;
}
h1{font-size:22px}
button{
  width:100%;
  padding:18px;
  font-size:18px;
  font-weight:700;
  border:none;
  border-radius:18px;
  background:#ff6a00;
  color:#fff;
}
video{
  width:100%;
  border-radius:20px;
  margin-top:20px;
  background:#000;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:20px;
  margin-top:20px;
}
input{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:14px;
  border:1px solid #cbd5e1;
}
.hidden{display:none}
</style>
</head>

<body>

<h1>游닍 Leitura por C칙mera (iPhone OK)</h1>

<button id="btnCamera">游닝 Abrir c칙mera</button>

<video id="video"
  playsinline
  autoplay
  muted
></video>

<div id="resultado"></div>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAAA">
</audio>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
let streamAtivo = null;
let lendo = false;

const video = document.getElementById("video");
const resultado = document.getElementById("resultado");
const beep = document.getElementById("beep");

document.getElementById("btnCamera").onclick = async () => {
  if(streamAtivo) return;

  try{
    // 游댮 PASSO CR칈TICO PARA IPHONE
    streamAtivo = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });

    video.srcObject = streamAtivo;
    await video.play();

    iniciarQuagga();
  }catch(err){
    alert("Permiss칚o de c칙mera negada");
  }
};

function iniciarQuagga(){
  if(lendo) return;
  lendo = true;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:video,
      constraints:{}
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_8_reader",
        "code_128_reader",
        "upc_reader",
        "upc_e_reader"
      ]
    },
    locate:true
  }, err=>{
    if(err){
      alert("Erro Quagga");
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(res=>{
    if(!res.codeResult?.code) return;

    const code = res.codeResult.code;

    beep.play();
    Quagga.stop();
    pararCamera();
    buscarProduto(code);
  });
}

function pararCamera(){
  lendo = false;
  if(streamAtivo){
    streamAtivo.getTracks().forEach(t=>t.stop());
    streamAtivo = null;
  }
}

async function buscarProduto(barcode){
  resultado.innerHTML = `<div class="card">游댌 Buscando ${barcode}...</div>`;

  const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`);
  const json = await resp.json();

  if(json.error){
    resultado.innerHTML = `<div class="card">${json.error}</div>`;
    return;
  }

  const p = json.produto;

  resultado.innerHTML = `
    <div class="card">
      <h2>${p.descricao}</h2>
      <p><b>ID:</b> ${p.id}</p>
      <p><b>Unidade:</b> ${p.unidadeDeVenda}</p>
      <p><b>Controla estoque:</b> ${p.controlaEstoque ? "Sim" : "N칚o"}</p>

      <label>Quantidade</label>
      <input type="number" value="1">
    </div>
  `;
}
</script>

</body>
</html>
