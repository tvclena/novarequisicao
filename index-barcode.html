<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de C√≥digo de Barras</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:20px;
  font-family:Inter,Arial;
  background:#f4f6f8;
  color:#111;
}
h1{font-size:22px;margin-bottom:16px}
button{
  width:100%;
  padding:16px;
  border-radius:16px;
  border:none;
  background:#ff6a00;
  color:#fff;
  font-size:18px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#020617;
  margin-top:10px;
}
video{
  width:100%;
  height:auto;
  border-radius:20px;
  margin-top:16px;
  background:#000;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:20px;
  margin-top:20px;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
input{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:14px;
  border:1px solid #cbd5e1;
}
.error{
  background:#fee2e2;
  color:#991b1b;
  padding:14px;
  border-radius:14px;
  margin-top:20px;
}
.hidden{display:none}
</style>
</head>

<body>

<h1>üì¶ Leitura por C√≥digo de Barras</h1>

<button onclick="iniciarCamera()">üì∑ Ativar c√¢mera</button>

<video id="video" playsinline muted></video>

<div id="resultado"></div>

<audio id="beep">
  <source src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAAA" type="audio/wav">
</audio>

<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<script>
let cameraAtiva = false;
let produtoAtual = null;

async function iniciarCamera(){
  if(cameraAtiva) return;

  const video = document.getElementById("video");

  // GARANTE PERMISS√ÉO
  await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }
  });

  Quagga.init({
    inputStream:{
      name:"Live",
      type:"LiveStream",
      target:video,
      constraints:{
        facingMode:"environment"
      }
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_8_reader",
        "code_128_reader",
        "upc_reader",
        "upc_e_reader"
      ]
    }
  }, err=>{
    if(err){
      alert("Erro ao iniciar c√¢mera");
      return;
    }
    Quagga.start();
    cameraAtiva = true;
  });

  Quagga.onDetected(result=>{
    const code = result.codeResult.code;
    if(!code) return;

    Quagga.stop();
    cameraAtiva = false;
    document.getElementById("beep").play();
    buscarProduto(code);
  });
}

async function buscarProduto(barcode){
  const resultado = document.getElementById("resultado");
  resultado.innerHTML = `<div class="card">üîç Buscando produto...</div>`;

  try{
    const resp = await fetch(`/api/buscar-barcode?barcode=${barcode}`);
    const json = await resp.json();

    if(json.error){
      resultado.innerHTML = `<div class="error">${json.error}</div>`;
      return;
    }

    produtoAtual = json.produto;
    const p = produtoAtual;

    resultado.innerHTML = `
      <div class="card">
        <h2>${p.descricao}</h2>

        <div class="grid">
          <div><b>ID:</b> ${p.id}</div>
          <div><b>Unidade:</b> ${p.unidadeDeVenda}</div>
          <div><b>Estoque:</b> ${p.controlaEstoque ? "Sim" : "N√£o"}</div>
          <div><b>Pre√ßo vari√°vel:</b> ${p.precoVariavel ? "Sim" : "N√£o"}</div>
        </div>

        <hr style="margin:18px 0">

        <label>Quantidade</label>
        <input id="quantidade" type="number" min="1" value="1">

        <button class="secondary" onclick="enviar()">üì§ Enviar requisi√ß√£o</button>
      </div>
    `;
  }catch(err){
    resultado.innerHTML = `<div class="error">${err.message}</div>`;
  }
}

async function enviar(){
  if(!produtoAtual){
    alert("Nenhum produto selecionado");
    return;
  }

  const qtd = Number(document.getElementById("quantidade").value);

  const body = {
    dataTransferencia: new Date().toISOString().slice(0,10),
    dataRecebimento: new Date().toISOString().slice(0,10),
    tipo: "TRANSFERENCIA",
    status: "ABERTA",
    modelo: "DIRETA",
    lojaId: 1,
    localOrigemId: 1,
    localDestinoId: 1,
    setorId: 1,
    solicitanteId: 112,
    motivoRequisicaoId: 1,
    observacaoGeral: "Leitura por c√¢mera",
    total: qtd,
    itens:[{
      produtoId: produtoAtual.id,
      quantidadeTransferida: qtd,
      observacao:"",
      custoMedio:0,
      custo:0,
      custoReposicao:0,
      custoFiscal:0
    }]
  };

  const resp = await fetch("/api/requisicao",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  if(resp.ok){
    alert("‚úÖ Requisi√ß√£o enviada");
    document.getElementById("resultado").innerHTML="";
  }else{
    alert("‚ùå Erro ao enviar requisi√ß√£o");
  }
}
</script>

</body>
</html>
